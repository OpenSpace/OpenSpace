local util = asset.require('./../../utility_functions')

----------------------------------------------------------------
-- STATES
----------------------------------------------------------------
local identifiers = { "Voyager1", "Voyager2", "Pioneer10", "Pioneer11" }

local fadeInTrails = [[
  openspace.setPropertyValueSingle("Scene.Voyager1.Renderable.Opacity", 1.0, 3.0);
]]

local fadeInTrails = function()
  local str = ""
  for key,identifier in ipairs(identifiers) do
    str = str .. [[
      openspace.setPropertyValueSingle(
        "Scene.]] .. identifier .. [[.Renderable.Enabled", true
      );
      openspace.setPropertyValueSingle(
        "Scene.]] .. identifier .. [[.Renderable.Opacity", 1.0, 3.0
      );
    ]]
  end
  return str
end

local fadeOutTrails = function()
  local str = ""
  for key,identifier in ipairs(identifiers) do
    str = str .. [[
      openspace.setPropertyValueSingle(
        "Scene.]] .. identifier .. [[.Renderable.Opacity", 0.0, 3.0
      );
    ]]
  end
  return str
end

-- OBS! Should match the time in the profile, or at least in the SolarSystem state
local today = "2021-08-27T12:58:03.505"

local voyagerPioneerNavigationState = [[{
  Anchor = "Sun",
  Pitch = 4.8502868388310596e-15,
  Position = { 14097490002262.918, 6855666924101.269, 34182234858284.91 },
  ReferenceFrame = "Root",
  Up = { -0.2122075783104489, 0.971316980781961, -0.10729057065851644 },
  Yaw = -8.616371505176941e-15
}]]

local doLinearFlightTo2021View = util.applyLinearFlight(3.6E13, 1.2)

local voyagerPioneerState = {
  Identifier = "VoyagerPioneer"
}

-- 1973 Pioneers reaches Jupiter
local time1973 = "1973-11-25T12:58:03.505";
local year1973state = {
  Identifier = "1973",
  Enter = util.applyLinearFlight(1.5E12, 1.2),
  Exit = [[]]
}

-- 1974 Pioneers reaches Jupiter
local time1974 = "1974-11-25T12:58:03.505";
local year1974state = {
  Identifier = "1974",
  Enter = util.applyLinearFlight(1.5E12, 1.2),
  Exit = [[]]
}

-- 1977 Voyagers launches
local time1977 = "1977-11-01T12:58:03.505";
local year1977state = {
  Identifier = "1977",
  Enter = util.applyLinearFlight(1.5E12, 1.2),
  Exit = [[]]
}

-- 1979 Pioneers reaches Saturn, Voyagers reaches Jupiter
local time1979 = "1979-09-09T12:58:03.505";
local year1979state = {
  Identifier = "1979",
  Enter = util.applyLinearFlight(3.0E12, 1.2),
  Exit = [[]]
}

-- 1986 Voyager 2 reacher Uranus
local time1986 = "1986-01-24T12:58:03.505";
local year1986state = {
  Identifier = "1986",
  Enter = util.applyLinearFlight(6.9E12, 1.2),
  Exit = [[]]
}

-- 1989 Voyager 2 reacher Neptune
local time1989 = "1989-09-09T12:58:03.505";
local year1989state = {
  Identifier = "1989",
  Enter = util.applyLinearFlight(9.7E12, 1.2),
  Exit = [[]]
}

local states = {
  voyagerPioneerState,
  year1973state,
  year1974state,
  year1977state,
  year1979state,
  year1986state,
  year1989state
}

----------------------------------------------------------------
-- TRANSITIONS within this substate
----------------------------------------------------------------
-- The action we want to happen when moving from any of the substates back
-- to the SolarSystem state
local onLeavingMainStateAction = [[
  ]] .. util.disableRoll() .. [[
  ]] .. util.stopOrbiting() .. [[
  ]] .. fadeOutTrails() .. [[
]]

local transitions = {
  -- Transition to/from this state
  {
    From = "Home",
    To = "VoyagerPioneer",
    Action = [[ 
      ]] .. util.setTime(today) .. [[
      ]] .. util.setCurveType("AvoidCollisionWithLookAt") .. [[
      ]] .. util.orbitConstantLatitudeOnArrival() .. [[
      ]] .. util.enableRoll() .. [[
      ]] .. util.flyToNavState(voyagerPioneerNavigationState) .. [[
      ]] .. fadeInTrails() .. [[
    ]]
  },
  {
    From = "VoyagerPioneer",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  -- 1973
  {
    From = "VoyagerPioneer",
    To = "1973",
    Action = util.setTime(time1973)
  },
  {
    From = "1973",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "1974",
    To = "1973",
    Action = util.interpolateTime(time1973)
  },
  {
    From = "1973",
    To = "1974",
    Action = util.interpolateTime(time1974)
  },
  {
    From = "1973",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  {
    From = "1979",
    To = "1973",
    Action = util.interpolateTime(time1973)
  },
  {
    From = "1973",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  {
    From = "1986",
    To = "1973",
    Action = util.interpolateTime(time1973)
  },
  {
    From = "1973",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  {
    From = "1989",
    To = "1973",
    Action = util.interpolateTime(time1973)
  },
  {
    From = "1973",
    To = "1977",
    Action = util.interpolateTime(time1977)
  },
  {
    From = "1977",
    To = "1973",
    Action = util.interpolateTime(time1973)
  },
  -- 1974
  {
    From = "VoyagerPioneer",
    To = "1974",
    Action = util.setTime(time1974)
  },
  {
    From = "1974",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "1974",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  {
    From = "1979",
    To = "1974",
    Action = util.interpolateTime(time1974)
  },
  {
    From = "1974",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  {
    From = "1986",
    To = "1974",
    Action = util.interpolateTime(time1974)
  },
  {
    From = "1974",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  {
    From = "1989",
    To = "1974",
    Action = util.interpolateTime(time1974)
  },
  {
    From = "1974",
    To = "1977",
    Action = util.interpolateTime(time1977)
  },
  {
    From = "1977",
    To = "1974",
    Action = util.interpolateTime(time1974)
  },
  -- 1977
  {
    From = "VoyagerPioneer",
    To = "1977",
    Action = util.setTime(time1977)
  },
  {
    From = "1977",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "1977",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  {
    From = "1979",
    To = "1977",
    Action = util.interpolateTime(time1977)
  },
  {
    From = "1977",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  {
    From = "1986",
    To = "1977",
    Action = util.interpolateTime(time1977)
  },
  {
    From = "1977",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  {
    From = "1989",
    To = "1977",
    Action = util.interpolateTime(time1977)
  },
  -- 1979
  {
    From = "VoyagerPioneer",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  {
    From = "1979",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "1979",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  {
    From = "1986",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  {
    From = "1979",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  {
    From = "1989",
    To = "1979",
    Action = util.interpolateTime(time1979)
  },
  -- 1986
  {
    From = "1986",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "VoyagerPioneer",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  {
    From = "1986",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  {
    From = "1989",
    To = "1986",
    Action = util.interpolateTime(time1986)
  },
  -- 1989
  {
    From = "1989",
    To = "VoyagerPioneer",
    Action = [[
      ]] .. util.interpolateTime(today) .. [[
      ]] .. doLinearFlightTo2021View .. [[
    ]]
  },
  {
    From = "VoyagerPioneer",
    To = "1989",
    Action = util.interpolateTime(time1989)
  },
  -- Back to SolarSystem from substates
  {
    From = "1973",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  {
    From = "1974",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  {
    From = "1977",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  {
    From = "1979",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  {
    From = "1986",
    To = "Home",
    Action = onLeavingMainStateAction
  },
  {
    From = "1989",
    To = "Home",
    Action = onLeavingMainStateAction
  }
}

asset.export("states", states)
asset.export("transitions", transitions)
