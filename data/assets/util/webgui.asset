asset.require('./static_server')

local guiCustomization = asset.require('customization/gui')

-- Select which commit hashes to use for the frontend and backend
local frontendHash = "2d1bb8d8d8478b6ed025ccc6f1e0ceacf04b6114"
local dataProvider = "data.openspaceproject.com/files/webgui"

local frontend = asset.syncedResource({
    Identifier = "WebGuiFrontend",
    Name = "Web Gui Frontend",
    Type = "UrlSynchronization",
    Url = dataProvider .. "/frontend/" ..  frontendHash .. "/frontend.zip"
})

asset.onInitialize(function ()
    -- Unzip the frontend bundle
    local dest = frontend .. "/frontend"
    if not openspace.directoryExists(dest) then
        openspace.unzipFile(frontend .. "/frontend.zip", dest, true)
    end

    -- Serve the production GUI:
    local directories = openspace.getPropertyValue("Modules.WebGui.Directories")
    directories[#directories + 1] = "frontend"
    directories[#directories + 1] = frontend .. '/frontend'
    openspace.setPropertyValueSingle("Modules.WebGui.Directories", directories)
    openspace.setPropertyValueSingle("Modules.WebGui.DefaultEndpoint", "frontend")

    if guiCustomization.webguiDevelopmentMode then
        -- Route CEF to the deveopment version of the GUI.
        -- This must be manually served using `npm start`
        -- in the OpenSpace-WebGuiFrontend repository.
        openspace.setPropertyValueSingle(
            "Modules.CefWebGui.GuiUrl",
            "http://127.0.0.1:4690/frontend/#/onscreen"
        )
    end

    -- The GUI contains date and simulation increment,
    -- so let's remove these from the dashboard.
    if openspace.getPropertyValue('Modules.CefWebGui.Visible') then
        openspace.setPropertyValueSingle('Dashboard.Date.Enabled', false)
        openspace.setPropertyValueSingle('Dashboard.SimulationIncrement.Enabled', false)
    end
end)

asset.onDeinitialize(function ()
    -- Remove the frontend endpoint
    local directories = openspace.getPropertyValue("Modules.WebGui.Directories")
    local newDirectories;

    openspace.setPropertyValueSingle("Modules.WebGui.DefaultEndpoint", "")

    for i = 0, #directories, 2 do
        if (string.find(directories[i], "frontend") == nil) then
            newDirectories[#newDirectories + 1] = directories[i]
            newDirectories[#newDirectories + 1] = directories[i + 1]
        end
    end
    openspace.setPropertyValueSingle("Modules.WebGui.Directories", newDirectories)
end)
