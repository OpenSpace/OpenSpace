asset.require("spice/base") -- openspace.time.advancedTime depends on SPICE

-- Function to advance a time stamp in the given number of days, hours, minutes and
-- seconds. returns the new time stamp
local function advance(time, days, hours, minutes, seconds)
  local result = openspace.time.advancedTime(
    openspace.time.advancedTime(
      openspace.time.advancedTime(
        openspace.time.advancedTime(time, tostring(days) .. "d"),
        tostring(hours) .. "h"),
      tostring(minutes) .. "m"),
    tostring(seconds) .. "s")

  return result
end

local launchTime = "2021-12-25T12:50:00.000"
local actionsList = {}

-- JWST timelapse timeline
local function createTimelapse()
  local timelapse = [[
    -- Setup 1 sec before
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 0, -1) .. [[",
      "",
      "openspace.scriptScheduler.clear(0)"
    )
    -- Mission start, setup 1 sec after
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 0, 1) .. [[",
      "openspace.setPropertyValueSingle(\"Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Settings.Gamma\", 0.7)" ..
      "openspace.setPropertyValueSingle(\"Scene.EarthAtmosphere.Renderable.Enabled\", false)",
      "openspace.time.interpolateDeltaTime(-1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"\")" ..
      "openspace.setPropertyValueSingle(\"Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Settings.Gamma\", 1.0)" ..
      "openspace.setPropertyValueSingle(\"Scene.EarthAtmosphere.Renderable.Enabled\", true)"
    )
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 0, 2) .. [[", -- 2 sec delay
      "openspace.time.interpolateDeltaTime(120)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"\")"
    )
    -- backwards, slow down in the end
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 4, 0) .. [[", -- 4 min pre delay
      "",
      "openspace.time.interpolateDeltaTime(-1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"\")"
    )

    -- array deploy, forwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 30 - 1, 20) .. [[", -- 1 min pre delay so time to interpolate
      "openspace.time.interpolateDeltaTime(1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 1 second/second\")"
    )
    -- array deploy, backwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 30, 20) .. [[",
      "",
      "openspace.time.interpolateDeltaTime(-120)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 minutes/second\")"
    )

    -- array complete, forwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 30, 42) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")"
    )
    -- array complete, backwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0, 30 + 1, 42 + 10) .. [[", -- 1 min 10 sec pre delay so time to interpolate
      "",
      "openspace.time.interpolateDeltaTime(-1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -1 second/second\")"
    )
    -- array complete, backwards prepare
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 0 + 1, 30 + 10, 42) .. [[", -- 1h 10 min delay for interpolation
      "",
      "openspace.time.interpolateDeltaTime(-120)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 minutes/second\")"
    )

    -- antenna deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
    advance(launchTime, 0, 18, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- antenna complete, forwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 23, 39, 0) .. [[",
      "openspace.time.interpolateDeltaTime(18000)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 5 hours/second\")"
    )
    -- antenna complete, backwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 0, 23 + 1, 39, 0) .. [[", -- 1h pre delay so time to interpolate
      "",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- fw palette deploy, forwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 2, 18 - 2, 20, 35) .. [[", -- 2h pre delay so time to interpolate
      "openspace.time.interpolateDeltaTime(3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 1 hour/second\")"
    )
    -- fw palette deploy, backwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 2, 18, 20, 35) .. [[",
      "",
      "openspace.time.interpolateDeltaTime(-18000)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -5 hours/second\")"
    )

    -- fw palette complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 3, 6, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -1 hour/second\")"
    )

    -- r palette deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 3, 8, 51, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- r palette complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 3, 12, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(120)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- base rise deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 3, 12, 22, 0) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")",
      "openspace.time.interpolateDeltaTime(-120)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 minutes/second\")"
    )

    -- base rise complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 4, 17, 35, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- aft flap deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 4, 21, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 10 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- aft flap complete, forwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 1, 37, 0) .. [[",
      "openspace.time.interpolateDeltaTime(3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 1 hour/second\")"
    )
    -- aft flap complete, backwards
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 1, 37 + 30, 0) .. [[", -- 30 min pre delay so time to interpolate
      "",
      "openspace.time.interpolateDeltaTime(-600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -10 minutes/second\")"
    )

    -- mid booms extend
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 11, 29, 43) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -1 hour/second\")"
    )

    -- first boom stop
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 12, 16, 16) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- right boom complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 17, 42, 5) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- left booms complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 22, 6, 0) .. [[",
      "openspace.time.interpolateDeltaTime(30)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 seconds/second\")",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- tension sun shield membranes
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 22, 9, 14) .. [[",
      "openspace.time.interpolateDeltaTime(60)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 1 minute/second\")",
      "openspace.time.interpolateDeltaTime(-30)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 seconds/second\")"
    )

    -- membrane tension complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 5, 22, 20, 0) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")",
      "openspace.time.interpolateDeltaTime(-60)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -1 minute/second\")"
    )

    -- membranes separate
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 6, 12, 36, 49) .. [[",
      "openspace.time.interpolateDeltaTime(3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 1 hour/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- secondary mirror deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 7, 0, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(18000)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 5 hours/second\")",
      "openspace.time.interpolateDeltaTime(-3600)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -1 hour/second\")"
    )

    -- secondary mirror complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 11, 10, 33, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 20 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-18000)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -5 hours/second\")"
    )

    -- aft radiator deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 11, 12, 20, 48) .. [[",
      "openspace.time.interpolateDeltaTime(1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 30 minutes/second\")",
      "openspace.time.interpolateDeltaTime(-1200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -20 minutes/second\")"
    )

    -- aft radiator complete, forward
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 11, 16, 5, 0) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")"
    )
    -- aft radiator complete, backward
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 11, 16 + 1, 5, 0) .. [[", -- 1h pre delay so time to interpolate
      "",
      "openspace.time.interpolateDeltaTime(-1800)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -30 minutes/second\")"
    )

    -- rt cord fold wings deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 12, 9, 30, 0) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- rt cord fold wings complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 13, 12, 40, 48) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- lft cord fold wings deploy
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 13, 23, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: 2 hours/second\")",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")"
    )

    -- lft cord fold wings complete
    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 14, 19, 0, 0) .. [[",
      "openspace.time.interpolateDeltaTime(1)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"\")" ..
      "openspace.setPropertyValueSingle(\"Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Settings.Gamma\", 1.0)" ..
      "openspace.setPropertyValueSingle(\"Scene.EarthAtmosphere.Renderable.Enabled\", true)",
      "openspace.time.interpolateDeltaTime(-7200)" ..
      "openspace.setPropertyValueSingle(\"Dashboard.JWSTStateText.Text\", \"Time speed: -2 hours/second\")" ..
      "openspace.setPropertyValueSingle(\"Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Settings.Gamma\", 0.7)" ..
      "openspace.setPropertyValueSingle(\"Scene.EarthAtmosphere.Renderable.Enabled\", false)"
    )

    openspace.scriptScheduler.loadScheduledScript("]] ..
      advance(launchTime, 14, 19, 0, 2) .. [[",
      "openspace.scriptScheduler.clear(0)"
    )
  ]]

  return timelapse
end

local function createActions()
  local playForwards = {
    Identifier = "jwst.play.forwards",
    Name = "Play JWST from start",
    Command = [[
      openspace.scriptScheduler.clear(0)
      openspace.time.setDeltaTime(1)
      openspace.setPropertyValueSingle("Dashboard.JWSTStateText.Text", "")
      openspace.time.setTime("]] .. launchTime .. [[")
      ]] .. createTimelapse() .. [[
      openspace.time.setDeltaTime(1)
    ]],
    Documentation = "Jump to the JWST launch time and play the timelapse of deployment forward",
    GuiPath = "/JWST",
    IsLocal = false
  }

  local playBackwards = {
    Identifier = "jwst.play.backwards",
    Name = "Play JWST from end",
    Command = [[
      openspace.scriptScheduler.clear(0)
      openspace.time.setDeltaTime(-1)
      openspace.setPropertyValueSingle("Dashboard.JWSTStateText.Text", "")
      openspace.time.setTime("2022 JAN 09 07:50:01")
      ]] .. createTimelapse() .. [[
      openspace.time.setDeltaTime(-1)
    ]],
    Documentation = "Jump to the end of JWST deployment time and play the timelapse of deployment in reverse",
    GuiPath = "/JWST",
    IsLocal = false
  }

  local clearPlay = {
    Identifier = "jwst.play.clear",
    Name = "Clear JWST timelapse",
    Command = [[
      openspace.scriptScheduler.clear(0)
      openspace.setPropertyValueSingle("Dashboard.JWSTStateText.Text", "")
      openspace.setPropertyValueSingle("Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Settings.Gamma", 1.0)
      openspace.setPropertyValueSingle("Scene.EarthAtmosphere.Renderable.Enabled", true)
      local deltaTime = openspace.time.deltaTime()
      if deltaTime > 0 then
        openspace.time.setDeltaTime(1)
      else
        openspace.time.setDeltaTime(-1)
      end
    ]],
    Documentation = "Set delta time back to realtime and clear the JWST deployment timelapse",
    GuiPath = "/JWST",
    IsLocal = false
  }

  local togglePlayDirection = {
    Identifier = "jwst.toggle.direction",
    Name = "Toggle forwards/ backwards",
    Command = [[
      -- Flip deltatime
      local deltaTime = openspace.time.deltaTime()
      openspace.time.setDeltaTime(-deltaTime)

      -- Update the dashboard text
      local text = openspace.getPropertyValue("Dashboard.JWSTStateText.Text")
      if(string.len(text) > 14) then
        local newText = ""
        if(text:sub(13, 13) == "-") then
          newText = text:sub(1,12) .. text:sub(14)
        else
          newText = text:sub(1,12) .. "-" .. text:sub(13)
        end
        openspace.setPropertyValueSingle("Dashboard.JWSTStateText.Text", tostring(newText))
      else
        openspace.setPropertyValueSingle("Dashboard.JWSTStateText.Text", "")
      end
    ]],
    Documentation = "Toggle deployment timelapse direction between forwards and backwards",
    GuiPath = "/JWST",
    IsLocal = false
  }

  return {playForwards, playBackwards, clearPlay, togglePlayDirection}
end

local text = {
  Type = "DashboardItemText",
  Identifier = "JWSTStateText",
  GuiName = "JWST State Dashboard Text",
  Text = ""
}

asset.onInitialize(function()
  actionsList = createActions()
  for i, action in ipairs(actionsList) do
    openspace.action.registerAction(action)
  end

  openspace.dashboard.addDashboardItem(text)
end)

asset.onDeinitialize(function()
  openspace.scriptScheduler.clear()
  openspace.dashboard.removeDashboardItem(text)

  for i = #actionsList, 1, -1 do
    openspace.action.removeAction(actionsList[i])
  end
end)


asset.meta = {
  Name = "James Webb Space Telescope Timelapse",
  Version = "1.0",
  Description = [[
    Scripts that are scheduled to alter the speed of the simulation time so the deployment
    of the James Webb Space Telescope looks smoother.
  ]],
  Author = "OpenSpace Team",
  URL = "http://openspaceproject.com",
  License = "MIT license"
}
