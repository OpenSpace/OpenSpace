local earthTransforms = asset.require("scene/solarsystem/planets/earth/transforms")
local sunTransforms = asset.require("scene/solarsystem/sun/transforms")
asset.require("spice/base")

local horizons = asset.syncedResource({
  Name = "JWST Horizons",
  Type = "HttpSynchronization",
  Identifier = "jwst_horizons",
  Version = 3
})

local JWSTPosition = {
  Identifier = "JWSTPosition",
  Parent = earthTransforms.EarthCenter.Identifier,
  Transform = {
    Translation = {
      Type = "TimelineTranslation",
      ShouldInterpolate = false,
      Keyframes = {
        ["2021 DEC 25 12:50:00"] = {
          Type = "HorizonsTranslation",
          HorizonsTextFile = horizons .. "horizons_jwst_launch.hrz",
        },
        ["2022 JAN 25 00:00:00"] = {
          Type = "HorizonsTranslation",
          HorizonsTextFile = horizons .. "horizons_jwst_orbit.hrz",
        }
      }
    },
  },
  GUI = {
    Name = "JWST Position",
    Path = "/Solar System/Missions/JWST",
    Hidden = true,
    Description = [[
      James Webb Space Telescope Position relative to Earth.
    ]],
  }
}

local JWSTRotation = {
  Identifier = "JWSTRotation",
  Parent = JWSTPosition.Identifier,
  Transform = {
    Rotation = {
      Type = "FixedRotation",
      Attached = "JWSTRotation",
      XAxis = { 1, 0, 0 },
      XAxisOrthogonal = true,
      YAxisInvert = true,
      YAxis = sunTransforms.SolarSystemBarycenter.Identifier
    }
  },
  GUI = {
    Name = "JWST Rotation",
    Path = "/Solar System/Missions/JWST",
    Hidden = true,
    Description = [[
      James Webb Space Telescope Rotation so the sunshield always faces the Sun.
    ]],
  }
}

-- Reparent the JWSTPosition node when the data changes at 25 Jan 2022
asset.onInitialize(function()
  openspace.scriptScheduler.loadScheduledScript(
    "2022 JAN 25 00:00:00",
    [[openspace.setParent("JWSTPosition", "L2")]],
    [[openspace.setParent("JWSTPosition", "EarthCenter")]],
    "",
    1 -- Not default group, never clear this script
  )

  openspace.addSceneGraphNode(JWSTPosition)
  openspace.addSceneGraphNode(JWSTRotation)
end)

asset.onDeinitialize(function()
  openspace.removeSceneGraphNode(JWSTRotation)
  openspace.removeSceneGraphNode(JWSTPosition)
  openspace.scriptScheduler.clear(1)
end)

asset.export(JWSTPosition)
asset.export(JWSTRotation)


asset.meta = {
  Name = "James Webb Space Telescope Transforms",
  Version = "1.0",
  Description = [[
    JWST transforms: JWST position relative to Earth and JWST rotation,
    a fixed rotation so sunshield always points toward the Sun.
  ]],
  Author = "OpenSpace Team",
  URL = "http://openspaceproject.com",
  License = "MIT license",
  Identifiers = {"JWSTPosition", "JWSTRotation"}
}
