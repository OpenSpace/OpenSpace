local earthAsset = asset.require('scene/solarsystem/planets/earth/earth')

local textures = asset.syncedResource({
  Name = "Cardinal Direction Textures",
  Type = "HttpSynchronization",
  Identifier = "cardinal_direction_textures",
  Version = 1
})


local Position = {
  Identifier = "CardinalDirectionsPosition",
  Parent = earthAsset.Earth.Identifier,
  Transform = {
    Translation = {
      Type = "GlobeTranslation",
      Globe = earthAsset.Earth.Identifier,
      Latitude = 0,
      Longitude = 0,
      Altitude = 0,
      UseCamera = true
    },
    Rotation = {
      Type = "GlobeRotation",
      Globe = earthAsset.Earth.Identifier,
      Latitude = 0,
      Longitude = 0,
      UseHeightmap = false,
      Angle = 270
    }
  },
  GUI = {
    Name = "Cardinal Directions Position",
    Path = "/Night Sky/Directions",
    Hidden = true
  }
}

local sphere = {
  Identifier = "CardinalDirectionSphere",
  Parent = Position.Identifier,
  Transform = {
    Scale = {
      Type = "StaticScale",
      Scale = 1
    },
    Rotation = {
      Type = "StaticRotation",
      Rotation = {-1.57079, 00.0, 0.0}
    },
  },
  Renderable = {
    Type = "RenderableSphere",
    Enabled = asset.enabled,
    Size = 50000,
    Segments = 80,
    Opacity = .9,
    Texture = textures..'/sphere.png',
    Orientation = "Inside",
    MirrorTexture = true,
    RenderBinMode = "PostDeferredTransparent"
  },
  GUI = {
    Name = "Cardinal Directions",
    Path = "/Night Sky/Directions"
  }
}

local showAction = {
  Identifier = "os.show_nesw",
  Name = "Show cardinal directions",
  Command = [[
    local lat, lon, alt = openspace.globebrowsing.getGeoPositionForCamera();
    local camera = openspace.navigation.getNavigationState();
    openspace.setParent('CardinalDirectionsPosition', camera.Anchor)
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Translation.Globe', camera.Anchor);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Translation.Latitude', lat);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Translation.Longitude', lon);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Rotation.Globe', camera.Anchor);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Rotation.Latitude', lat);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionsPosition.Rotation.Longitude', lon);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionSphere.Renderable.Enabled', true);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionSphere.Renderable.Fade', 0);
    openspace.setPropertyValueSingle('Scene.CardinalDirectionSphere.Renderable.Fade', 1, 1);
  ]],
  Documentation = "Shows the cardinal direction sphere and updates it to your current position",
  GuiPath = "/Night Sky/Directions",
  IsLocal = false
}

local hideAction = {
  Identifier = "os.hide_nesw",
  Name = "Hide cardinal directions",
  Command = [[
    openspace.setPropertyValueSingle('Scene.CardinalDirectionSphere.Renderable.Fade', 0, 1);
  ]],
  Documentation = "Hides the cardinal directions",
  GuiPath = "/Night Sky/Directions",
  IsLocal = false
}


asset.onInitialize(function()
  openspace.addSceneGraphNode(Position)
  openspace.addSceneGraphNode(sphere)
  openspace.action.registerAction(hideAction)
  openspace.action.registerAction(showAction)
end)

asset.onDeinitialize(function()
  openspace.action.removeAction(showAction)
  openspace.action.removeAction(hideAction)
  openspace.removeSceneGraphNode(sphere)
  openspace.removeSceneGraphNode(Position)
end)

asset.export(showAction)
asset.export(hideAction)
asset.export(sphere)
asset.export(Position)
